<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Tjollas Ultra Super Duper Stats Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.24.6/babel.min.js"></script>
  <script src="https://wow.zamimg.com/widgets/power.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    img {
        border-radius: 0.375rem; /* Tailwind's rounded-md */
        border: 3px solid #131212; /* Tailwind's border-gray-800 */
    }
    /* Mobile table styling */
    @media (max-width: 640px) {
      thead {
        display: none;
      }
      tr {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 1rem;
        border: 1px solid #374151; /* border-gray-700 */
        border-radius: 0.5rem;
        background-color: #1f2937; /* bg-gray-800 */
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
      td {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        width: 100%;
        border-bottom: 1px solid #4b5563; /* border-gray-600 */
      }
      td:last-child {
        border-bottom: none;
      }
      td:before {
        content: attr(data-label);
        font-weight: 600;
        color: #9ca3af; /* text-gray-400 */
        flex: 0 0 30%;
        margin-right: 0.5rem;
      }
      .gear-cell {
        flex-direction: column;
        align-items: flex-start;
      }
      .gear-cell .flex {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      .spec-cell {
        display: flex;
        align-items: center;
      }
    }
    /* Desktop table styling */
    @media (min-width: 641px) {
      td {
        vertical-align: middle;
      }
      .gear-cell .flex {
        gap: 0.5rem;
      }
    }
  </style>
</head>
<body class="bg-gray-900 text-white font-sans">
  <div id="root"></div>
  <script type="text/babel">
    function App() {
      const [players, setPlayers] = React.useState([]);
      const [playerData, setPlayerData] = React.useState([]);
      const [gearData, setGearData] = React.useState([]);
      const [itemIconMap, setItemIconMap] = React.useState({});
      const [searchTerm, setSearchTerm] = React.useState('');
      const [sortConfig, setSortConfig] = React.useState({ key: 'bpa', direction: 'desc' });
      const [error, setError] = React.useState(null);
      const [expandedRows, setExpandedRows] = React.useState({});

      // Spec-to-icon mapping
      const specIcons = {
        elemental: "https://cdn.discordapp.com/emojis/637564379595931649.png",
        protection: "https://cdn.discordapp.com/emojis/637564444834136065.png",
        assassination: "https://cdn.discordapp.com/emojis/637564351707873324.png",
        fury: "https://cdn.discordapp.com/emojis/637564445215948810.png",
        arms: "https://cdn.discordapp.com/emojis/637564445031399474.png",
        enhancement: "https://cdn.discordapp.com/emojis/936357056951222322.png",
        destruction: "https://cdn.discordapp.com/emojis/637564406682877964.png",
        affliction: "https://cdn.discordapp.com/emojis/637564406984867861.png",
        demonology: "https://cdn.discordapp.com/emojis/637564407001513984.png",
        balance: "https://cdn.discordapp.com/emojis/637564171994529798.png",
        beastmastery: "https://cdn.discordapp.com/emojis/637564202021814277.png",
        survival: "https://cdn.discordapp.com/emojis/637564202130866186.png",
        melee: "https://cdn.discordapp.com/emojis/637564202130866186.png",
        marksmanship: "https://cdn.discordapp.com/emojis/637564202084466708.png",
        guardian: "https://cdn.discordapp.com/emojis/637564171696734209.png",
        feral: "https://cdn.discordapp.com/emojis/637564172061900820.png",
        combat: "https://cdn.discordapp.com/emojis/637564352333086720.png",
        subtlety: "https://cdn.discordapp.com/emojis/637564352169508892.png",
        arcane: "https://cdn.discordapp.com/emojis/637564231545389056.png",
        shadow: "https://cdn.discordapp.com/emojis/637564323291725825.png",
        fire: "https://cdn.discordapp.com/emojis/637564231239073802.png",
        frost: "https://cdn.discordapp.com/emojis/637564231469891594.png",
        discipline: "https://cdn.discordapp.com/emojis/637564323442720768.png",
        holy: "https://cdn.discordapp.com/emojis/637564323530539019.png",
        default: "https://wow.zamimg.com/images/wow/icons/small/inv_misc_questionmark.jpg"
      };

      // Function to get Tailwind CSS text color class based on parse percentile
      const getParseColor = (percent) => {
        if (typeof percent !== 'number' || isNaN(percent)) return 'text-white';
        if (percent === 100) return 'text-amber-200';
        if (percent >= 99) return 'text-pink-400';
        if (percent >= 95) return 'text-orange-400';
        if (percent >= 75) return 'text-purple-500';
        if (percent >= 50) return 'text-blue-400';
        if (percent >= 25) return 'text-green-400';
        return 'text-gray-400';
      };

      // Fetch data from JSON files
      React.useEffect(() => {
        Promise.all([
          fetch('players.json').then(res => res.json()).catch(err => {
            console.error('Failed to fetch players.json:', err);
            return [];
          }),
          fetch('playerData.json').then(res => res.json()).catch(err => {
            console.error('Failed to fetch playerData.json:', err);
            return [];
          }),
          fetch('gear.json').then(res => res.json()).catch(err => {
            console.error('Failed to fetch gear.json:', err);
            return { players: [] };
          }),
          fetch('materials.json').then(res => res.json()).catch(err => {
            console.error('Failed to fetch materials.json:', err);
            return [];
          })
        ])
          .then(([playersData, playerData, gearData, materialsData]) => {
            setPlayers(Array.isArray(playersData) ? playersData : []);
            setPlayerData(Array.isArray(playerData) ? playerData : []);
            setGearData(Array.isArray(gearData.players) ? gearData.players : []);
            const iconMap = materialsData.reduce((map, item) => {
              if (item.itemId && item.iconname) {
                map[item.itemId] = item.iconname;
              }
              return map;
            }, {});
            setItemIconMap(iconMap);
          })
          .catch(error => {
            console.error('Error fetching data:', error);
            setError('Failed to load data. Please check the JSON files.');
          });
      }, []);

      // Combine player data with Discord names, server names, and gear
      const combinedData = [];
      players.forEach(playerInfo => {
        if (!playerInfo.player_names || !Array.isArray(playerInfo.player_names)) {
          console.warn('Skipping playerInfo with missing or invalid player_names:', playerInfo);
          return;
        }
        playerInfo.player_names.forEach(playerName => {
          if (!playerName) return;
          const playerStats = playerData.find(p => p.n && p.n.toLowerCase() === playerName.toLowerCase());
          if (playerStats) {
            const normalizedServerNames = (playerInfo.server_names || []).map(name => 
              name && typeof name === 'string' ? name.toLowerCase().replace(/\s+/g, '-') : ''
            ).filter(name => name);
            const gear = gearData.find(g => {
              if (!g.name) {
                console.warn('Invalid gear entry (missing name):', g);
                return false;
              }
              const nameMatch = g.name.toLowerCase() === playerName.toLowerCase();
              return nameMatch;
            });
            combinedData.push({
              ...playerStats,
              discord_names: playerInfo.discord_names?.join(', ') || 'N/A',
              server_names: playerInfo.server_names?.join(', ') || 'N/A',
              extraSpecs: playerStats.allStars ? Math.max(0, playerStats.allStars.length - 1) : 0,
              gear: gear && gear.equipment?.equipped_items ? gear.equipment.equipped_items : []
            });
          }
        });
      });

      // Filter and sort data
      const filteredData = combinedData.filter(player =>
        (player.n || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
        (player.discord_names || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
        (player.server_names || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
        (player.allStars?.some(spec => spec.spec?.toLowerCase().includes(searchTerm.toLowerCase())) || false)
      );

      const sortedData = [...filteredData].sort((a, b) => {
        const getValue = (obj, key) => {
          if (key === 'bpa') {
            const rankPercent = obj.allStars?.[0]?.rankPercent;
            return typeof rankPercent === 'number' && !isNaN(rankPercent) ? rankPercent : 0;
          }
          if (key === 'mpa') {
            const points = obj.allStars?.[0]?.points;
            return typeof points === 'number' && !isNaN(points) ? points : 0;
          }
          if (key === 'extraSpecs') return typeof obj.extraSpecs === 'number' ? obj.extraSpecs : 0;
          return obj[key] || '';
        };
        const aValue = getValue(a, sortConfig.key);
        const bValue = getValue(b, sortConfig.key);

        if (sortConfig.key === 'bpa') {
          if (aValue === bValue) {
            const aPoints = getValue(a, 'mpa');
            const bPoints = getValue(b, 'mpa');
            return sortConfig.direction === 'asc'
              ? aPoints - bPoints
              : bPoints - aPoints;
          }
          return sortConfig.direction === 'asc'
            ? aValue - bValue
            : bValue - aValue;
        }

        if (typeof aValue === 'string' && typeof bValue === 'string') {
          return sortConfig.direction === 'asc'
            ? aValue.localeCompare(bValue)
            : bValue.localeCompare(aValue);
        }

        return sortConfig.direction === 'asc'
          ? aValue - bValue
          : bValue - aValue;
      });

      const handleSort = (key) => {
        setSortConfig(prev => ({
          key,
          direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc'
        }));
      };

      const toggleRow = (playerName) => {
        setExpandedRows(prev => ({
          ...prev,
          [playerName]: !prev[playerName]
        }));
      };

      const formatNumber = (value) => {
        return typeof value === 'number' && !isNaN(value) ? value.toFixed(2) : 'N/A';
      };

      const getSpecIcon = (spec) => {
        const normalizedSpec = spec?.toLowerCase() || '';
        return specIcons[normalizedSpec] || specIcons.default;
      };

      if (error) {
        return (
          <div className="min-h-screen bg-gray-900 p-4 sm:p-6 flex items-center justify-center">
            <div className="text-red-400 text-lg sm:text-xl font-semibold bg-gray-800 p-4 rounded-lg shadow-lg">Failed to load data. Please check the JSON files.</div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-900 p-4 sm:p-6">
          <div className="max-w-full sm:max-w-7xl mx-auto">
            <h1 className="text-2xl sm:text-3xl font-bold text-blue-400 mb-4 sm:mb-6">Tjollas Ultra Super Duper Stats Dashboard</h1>
            <input
              type="text"
              placeholder="Search by Player, Server Name, or Spec..."
              className="w-full p-3 mb-4 bg-gray-800 text-white border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base placeholder-gray-400"
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
            />
            <div className="overflow-x-auto shadow-lg rounded-lg">
              <table className="w-full text-left border-collapse bg-gray-800 rounded-lg">
                <thead className="bg-gray-700 text-gray-200">
                  <tr>
                    <th className="p-3 sm:p-4 cursor-pointer hover:bg-gray-600 text-sm font-semibold" onClick={() => handleSort('spec')}>
                      Spec {sortConfig.key === 'spec' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                    </th>
                    <th className="p-3 sm:p-4 cursor-pointer hover:bg-gray-600 text-sm font-semibold" onClick={() => handleSort('n')}>
                      Player {sortConfig.key === 'n' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                    </th>
                    <th className="p-3 sm:p-4 cursor-pointer hover:bg-gray-600 text-sm font-semibold" onClick={() => handleSort('server_names')}>
                      Discord {sortConfig.key === 'server_names' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                    </th>
                    <th className="p-3 sm:p-4 cursor-pointer hover:bg-gray-600 text-sm font-semibold" onClick={() => handleSort('bpa')}>
                      % {sortConfig.key === 'bpa' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                    </th>
                    <th className="p-3 sm:p-4 cursor-pointer hover:bg-gray-600 text-sm font-semibold" onClick={() => handleSort('mpa')}>
                      Rank {sortConfig.key === 'mpa' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                    </th>
                    <th className="p-3 sm:p-4 text-sm font-semibold">Gear</th>
                  </tr>
                </thead>
                <tbody>
                  {sortedData.map(player => (
                    <React.Fragment key={player.n || Math.random()}>
                      <tr
                        className={`border-t border-gray-700 hover:bg-gray-600 transition-colors duration-200 ${
                          player.extraSpecs > 0 ? 'cursor-pointer' : 'cursor-default'
                        }`}
                        onClick={() => player.extraSpecs > 0 && toggleRow(player.n)}
                      >
                        <td data-label="Spec" className="p-3 sm:p-4 group relative spec-cell">
                          <div className="flex items-center gap-2">
                            <img
                              src={getSpecIcon(player.allStars?.[0]?.spec)}
                              alt={player.allStars?.[0]?.spec || 'Unknown Spec'}
                              className="w-6 h-6 sm:w-7 sm:h-7"
                            />
                            {player.extraSpecs > 0 && (
                              <span
                                className="bg-green-600 text-white text-xs font-semibold rounded-full px-2 py-1 group-hover:bg-green-500 transition-colors"
                              >
                                +{player.extraSpecs}
                              </span>
                            )}
                          </div>
                          <span className="absolute left-0 top-full mt-2 hidden group-hover:block sm:group-hover:block bg-gray-700 text-white text-xs rounded py-1 px-2 z-10 shadow-md">
                            Spec: {player.allStars?.[0]?.spec || 'N/A'}
                          </span>
                        </td>
                        <td data-label="Player Name" className="p-3 sm:p-4 text-sm sm:text-base font-medium">
                          {player.n || 'Unknown'}
                        </td>
                        <td data-label="Discord Name" className="p-3 sm:p-4 group relative text-sm sm:text-base">
                          {player.server_names}
                          <span className="absolute left-0 top-full mt-2 hidden group-hover:block sm:group-hover:block bg-gray-700 text-white text-xs rounded py-1 px-2 z-10 shadow-md">
                            Discord: {player.discord_names}
                          </span>
                        </td>
                        <td data-label="%" className={`p-3 sm:p-4 ${getParseColor(player.allStars?.[0]?.rankPercent)} text-sm sm:text-base font-medium`}>
                          {formatNumber(player.allStars?.[0]?.rankPercent || 'N/A')}
                        </td>
                        <td data-label="Rank" className="p-3 sm:p-4 text-sm sm:text-base font-medium text-center sm:text-left">
                          {player.allStars?.[0]?.serverRank || 'N/A'}
                        </td>
                        <td data-label="Gear" className="p-3 sm:p-4 gear-cell">
                          <div className="flex flex-wrap gap-2">
                            {player.gear.length > 0 ? (
                              player.gear.map((item, index) => {
                                const itemId = item.item ? item.item.id : 'unknown';
                                const iconName = itemIconMap[itemId] || 'inv_misc_questionmark';
                                let wowheadData = `item=${itemId}&domain=classic`;
                                if (item.enchantments && item.enchantments.length > 0) {
                                  const enchIds = item.enchantments.map(ench => ench.enchantment_id).join('.');
                                  wowheadData += `&ench=${enchIds}`;
                                }
                                return (
                                  <a
                                    key={index}
                                    href={`https://www.wowhead.com/classic/item=${itemId}`}
                                    data-wowhead={wowheadData}
                                    className="group relative"
                                  >
                                    <img
                                      src={`https://wow.zamimg.com/images/wow/icons/small/${iconName}.jpg`}
                                      alt={item.name || 'Unknown Item'}
                                      title={item.name || 'Unknown Item'}
                                    />
                                  </a>
                                );
                              })
                            ) : (
                              <span className="text-gray-400 text-sm">No gear data available.</span>
                            )}
                          </div>
                        </td>
                      </tr>
                      {expandedRows[player.n] && player.allStars?.slice(1).map((spec, index) => (
                        <tr key={`${player.n}-${index}`} className="border-t border-gray-700 bg-gray-700 hover:bg-gray-600 transition-colors duration-200">
                          <td data-label="Spec" className="p-3 sm:p-4 group relative spec-cell">
                            <div className="flex items-center gap-2">
                              <img
                                src={getSpecIcon(spec.spec)}
                                alt={spec.spec || 'Unknown Spec'}
                                className="w-6 h-6 sm:w-7 sm:h-7"
                              />
                            </div>
                            <span className="absolute left-0 top-full mt-2 hidden group-hover:block sm:group-hover:block bg-gray-700 text-white text-xs rounded py-1 px-2 z-10 shadow-md">
                              Spec: {spec.spec || 'N/A'}
                            </span>
                          </td>
                          <td data-label="Player Name" className="p-3 sm:p-4 pl-6 italic text-sm sm:text-base font-medium">
                            {player.n || 'Unknown'}
                          </td>
                          <td data-label="Discord Name" className="p-3 sm:p-4 group relative text-sm sm:text-base">
                            {player.server_names}
                            <span className="absolute left-0 top-full mt-2 hidden group-hover:block sm:group-hover:block bg-gray-700 text-white text-xs rounded py-1 px-2 z-10 shadow-md">
                              Discord: {player.discord_names}
                            </span>
                          </td>
                          <td data-label="%" className={`p-3 sm:p-4 ${getParseColor(spec.rankPercent)} text-sm sm:text-base font-medium`}>
                            {formatNumber(spec.rankPercent)}
                          </td>
                          <td data-label="Rank" className="p-3 sm:p-4 text-sm sm:text-base font-medium text-center sm:text-left">
                            {spec.serverRank || 'N/A'}
                          </td>
                          <td data-label="Gear" className="p-3 sm:p-4 text-gray-400 text-sm">-</td>
                        </tr>
                      ))}
                    </React.Fragment>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
