<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tjollas Ultra Super Duper Stats Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.24.6/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white font-sans">
  <div id="root"></div>
  <script type="text/babel">
    function App() {
      const [players, setPlayers] = React.useState([]);
      const [playerData, setPlayerData] = React.useState([]);
      const [searchTerm, setSearchTerm] = React.useState('');
      const [sortConfig, setSortConfig] = React.useState({ key: 'n', direction: 'asc' });
      const [error, setError] = React.useState(null);
      const [expandedRows, setExpandedRows] = React.useState({});

      // Fetch data from JSON files
      React.useEffect(() => {
        Promise.all([
          fetch('players.json').then(res => res.json()).catch(() => []),
          fetch('playerData.json').then(res => res.json()).catch(() => [])
        ])
          .then(([playersData, playerData]) => {
            setPlayers(playersData);
            setPlayerData(playerData);
          })
          .catch(error => {
            console.error('Error fetching data:', error);
            setError('Failed to load data. Please check the JSON files.');
          });
      }, []);

      // Combine player data with Discord names and server names
      const combinedData = [];
      players.forEach(playerInfo => {
        playerInfo.player_names.forEach(playerName => {
          const playerStats = playerData.find(p => p.n === playerName);
          if (playerStats) {
            combinedData.push({
              ...playerStats,
              discord_names: playerInfo.discord_names.join(', '),
              server_names: playerInfo.server_names.join(', '),
              extraSpecs: playerStats.allStars ? Math.max(0, playerStats.allStars.length - 1) : 0
            });
          }
        });
      });

      // Filter and sort data
      const filteredData = combinedData.filter(player =>
        (player.n || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
        (player.discord_names || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
        (player.server_names || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
        (player.allStars?.some(spec => spec.spec.toLowerCase().includes(searchTerm.toLowerCase())) || false)
      );

      const sortedData = [...filteredData].sort((a, b) => {
        if (sortConfig.key === 'n' || sortConfig.key === 'discord_names' || sortConfig.key === 'server_names' || sortConfig.key === 'spec') {
          const aValue = sortConfig.key === 'spec' ? (a.allStars?.[0]?.spec || '') : (a[sortConfig.key] || '');
          const bValue = sortConfig.key === 'spec' ? (b.allStars?.[0]?.spec || '') : (b[sortConfig.key] || '');
          return sortConfig.direction === 'asc'
            ? aValue.localeCompare(bValue)
            : bValue.localeCompare(aValue);
        } else {
          const aValue = typeof a[sortConfig.key] === 'number' ? a[sortConfig.key] : -Infinity;
          const bValue = typeof b[sortConfig.key] === 'number' ? b[sortConfig.key] : -Infinity;
          return sortConfig.direction === 'asc'
            ? aValue - bValue
            : bValue - aValue;
        }
      });

      const handleSort = (key) => {
        setSortConfig(prev => ({
          key,
          direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc'
        }));
      };

      const toggleRow = (playerName) => {
        setExpandedRows(prev => ({
          ...prev,
          [playerName]: !prev[playerName]
        }));
      };

      // Format number safely
      const formatNumber = (value) => {
        return typeof value === 'number' && !isNaN(value) ? value.toFixed(2) : 'N/A';
      };

      if (error) {
        return (
          <div className="min-h-screen bg-gray-900 p-6 flex items-center justify-center">
            <div className="text-red-400 text-xl">{error}</div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-900 p-6">
          <div className="max-w-7xl mx-auto">
            <h1 className="text-3xl font-bold text-blue-400 mb-6">Tjollas Ultra Super Duper Stats Dashboard</h1>
            <input
              type="text"
              placeholder="Search by Player, Discord, Server Name, or Spec..."
              className="w-full p-2 mb-4 bg-gray-800 text-white border border-gray-700 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
            />
            <div className="overflow-x-auto">
              <table className="w-full text-left border-collapse bg-gray-800 rounded-lg">
                <thead>
                  <tr className="bg-gray-700">
                    <th className="p-3 cursor-pointer hover:bg-gray-600" onClick={() => handleSort('n')}>
                      Player Name {sortConfig.key === 'n' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                    </th>
                    <th className="p-3 cursor-pointer hover:bg-gray-600" onClick={() => handleSort('discord_names')}>
                      Discord Name {sortConfig.key === 'discord_names' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                    </th>
                    <th className="p-3 cursor-pointer hover:bg-gray-600" onClick={() => handleSort('server_names')}>
                      Server Name {sortConfig.key === 'server_names' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                    </th>
                    <th className="p-3 cursor-pointer hover:bg-gray-600" onClick={() => handleSort('bpa')}>
                      % {sortConfig.key === 'bpa' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                    </th>
                    <th className="p-3 cursor-pointer hover:bg-gray-600" onClick={() => handleSort('mpa')}>
                      Points {sortConfig.key === 'mpa' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                    </th>
                    <th className="p-3 cursor-pointer hover:bg-gray-600" onClick={() => handleSort('spec')}>
                      Spec {sortConfig.key === 'spec' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                    </th>
                    <th className="p-3">Role</th>
                    <th className="p-3 cursor-pointer hover:bg-gray-600" onClick={() => handleSort('extraSpecs')}>
                      Extra Specs {sortConfig.key === 'extraSpecs' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {sortedData.map(player => (
                    <React.Fragment key={player.n || Math.random()}>
                      <tr
                        className="border-t border-gray-700 hover:bg-gray-600 cursor-pointer"
                        onClick={() => toggleRow(player.n)}
                      >
                        <td className="p-3">{player.n || 'Unknown'}</td>
                        <td className="p-3">{player.discord_names}</td>
                        <td className="p-3">{player.server_names}</td>
                        <td className="p-3">{formatNumber(player.allStars?.[0]?.rankPercent || 'N/A')}</td>
                        <td className="p-3">{formatNumber(player.allStars?.[0]?.points || 'N/A')}</td>
                        <td className="p-3">{player.allStars?.[0]?.spec || 'N/A'}</td>
                        <td className="p-3">{player.mt?.toUpperCase() || 'N/A'}</td>
                        <td className="p-3">{player.extraSpecs > 0 ? `+${player.extraSpecs}` : '0'}</td>
                      </tr>
                      {expandedRows[player.n] && player.allStars?.slice(1).map((spec, index) => (
                        <tr key={`${player.n}-${index}`} className="border-t border-gray-800 bg-gray-700">
                          <td className="p-3 pl-6 italic">{player.n || 'Unknown'}</td>
                          <td className="p-3">{player.discord_names}</td>
                          <td className="p-3">{player.server_names}</td>
                          <td className="p-3">{formatNumber(spec.rankPercent)}</td>
                          <td className="p-3">{formatNumber(spec.points)}</td>
                          <td className="p-3">{spec.spec || 'N/A'}</td>
                          <td className="p-3">{player.mt?.toUpperCase() || 'N/A'}</td>
                          <td className="p-3">-</td>
                        </tr>
                      ))}
                    </React.Fragment>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
